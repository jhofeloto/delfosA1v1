{% extends "base.html" %}

{% block title %}Carga Masiva - Pipeline DM2{% endblock %}

{% block content %}
<div class="col-12">
    <!-- Header -->
    <div class="gradient-bg rounded-3 p-4 mb-4">
        <h1 class="display-5 fw-bold mb-2">
            <i class="fas fa-upload me-3"></i>
            Predicción Masiva por Archivo CSV
        </h1>
        <p class="lead mb-0">
            Sube un archivo CSV con datos de múltiples pacientes para obtener predicciones en lote
        </p>
    </div>

    {% if not model_loaded %}
    <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Modelo no disponible.</strong> 
        Ejecuta primero el pipeline para entrenar el modelo.
    </div>
    {% endif %}

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-4">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show">
                        {% if category == 'error' %}
                            <i class="fas fa-exclamation-triangle me-2"></i>
                        {% elif category == 'success' %}
                            <i class="fas fa-check-circle me-2"></i>
                        {% else %}
                            <i class="fas fa-info-circle me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="row">
        <!-- Formulario de Upload -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-csv me-2"></i>Cargar Archivo CSV
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="uploadForm">
                        <div class="mb-4">
                            <label for="file" class="form-label fw-bold">Seleccionar archivo CSV</label>
                            <input type="file" class="form-control" id="file" name="file" 
                                   accept=".csv" required {{ 'disabled' if not model_loaded }}>
                            <div class="form-text">
                                Solo se permiten archivos .csv (máximo 16MB)
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" 
                                    {{ 'disabled' if not model_loaded }}>
                                <i class="fas fa-cloud-upload-alt me-2"></i>
                                Procesar Archivo
                            </button>
                        </div>
                    </form>
                    
                    <!-- Progress Bar -->
                    <div class="progress mt-3" id="uploadProgress" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información y Ayuda -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>Formato del Archivo
                    </h6>
                </div>
                <div class="card-body">
                    <p><strong>Columnas requeridas:</strong></p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>edad</li>
                        <li><i class="fas fa-check text-success me-2"></i>peso</li>
                        <li><i class="fas fa-check text-success me-2"></i>talla</li>
                        <li><i class="fas fa-check text-success me-2"></i>sexo</li>
                    </ul>
                    
                    <p><strong>Columnas opcionales:</strong></p>
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-circle text-secondary me-2" style="font-size: 0.5rem;"></i>imc</li>
                        <li><i class="fas fa-circle text-secondary me-2" style="font-size: 0.5rem;"></i>tas, tad</li>
                        <li><i class="fas fa-circle text-secondary me-2" style="font-size: 0.5rem;"></i>perimetro_abdominal</li>
                        <li><i class="fas fa-circle text-secondary me-2" style="font-size: 0.5rem;"></i>medicamentos_hta</li>
                        <li><i class="fas fa-circle text-secondary me-2" style="font-size: 0.5rem;"></i>Y otras...</li>
                    </ul>
                </div>
            </div>

            <!-- Descargas -->
            <div class="card mt-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-download me-2"></i>Archivos de Prueba
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <!-- Dataset de Prueba Completo -->
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-success mb-2">
                                <i class="fas fa-vials me-2"></i>Dataset de Prueba
                            </h6>
                            <p class="small text-muted mb-2">
                                25 casos clínicos realistas para probar predicción masiva
                            </p>
                            <button class="btn btn-success btn-sm w-100" onclick="downloadTestDataset()">
                                <i class="fas fa-file-csv me-2"></i>Descargar Test Dataset
                            </button>
                        </div>
                        
                        <!-- Plantilla Vacía -->
                        <div class="border rounded p-3">
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-file-alt me-2"></i>Plantilla Vacía
                            </h6>
                            <p class="small text-muted mb-2">
                                Archivo CSV con solo las columnas necesarias
                            </p>
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="downloadTemplate()">
                                <i class="fas fa-download me-2"></i>Descargar Plantilla
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Importante
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-shield-alt text-primary me-2"></i>
                            <small>Los datos se procesan localmente</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-clock text-info me-2"></i>
                            <small>Procesamiento puede tardar según el tamaño</small>
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-user-md text-success me-2"></i>
                            <small>Resultados son solo orientativos</small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Ejemplo de Datos -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Ejemplo de Datos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>edad</th>
                                    <th>sexo</th>
                                    <th>peso</th>
                                    <th>talla</th>
                                    <th>imc</th>
                                    <th>tas</th>
                                    <th>tad</th>
                                    <th>perimetro_abdominal</th>
                                    <th>realiza_ejercicio</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>45</td>
                                    <td>M</td>
                                    <td>80.5</td>
                                    <td>175.0</td>
                                    <td>26.2</td>
                                    <td>130</td>
                                    <td>85</td>
                                    <td>95.0</td>
                                    <td>SI</td>
                                </tr>
                                <tr>
                                    <td>38</td>
                                    <td>F</td>
                                    <td>65.0</td>
                                    <td>160.0</td>
                                    <td>25.4</td>
                                    <td>120</td>
                                    <td>80</td>
                                    <td>85.0</td>
                                    <td>NO</td>
                                </tr>
                                <tr>
                                    <td>52</td>
                                    <td>M</td>
                                    <td>92.0</td>
                                    <td>170.0</td>
                                    <td>31.8</td>
                                    <td>145</td>
                                    <td>95</td>
                                    <td>102.0</td>
                                    <td>SI</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#uploadForm').on('submit', function(e) {
        if (!$('#file')[0].files.length) {
            e.preventDefault();
            showAlert('Por favor selecciona un archivo', 'error');
            return;
        }
        
        // Mostrar progress bar
        $('#uploadProgress').show();
        $('.progress-bar').css('width', '0%');
        
        // Simular progreso
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress >= 90) {
                progress = 90;
                clearInterval(interval);
            }
            $('.progress-bar').css('width', progress + '%');
        }, 200);
        
        // El formulario se envía normalmente
    });
    
    // Validación de archivo
    $('#file').on('change', function() {
        const file = this.files[0];
        if (file) {
            const fileSize = file.size / 1024 / 1024; // MB
            const fileName = file.name.toLowerCase();
            
            if (!fileName.endsWith('.csv')) {
                showAlert('Solo se permiten archivos CSV', 'error');
                this.value = '';
                return;
            }
            
            if (fileSize > 16) {
                showAlert('El archivo es demasiado grande (máximo 16MB)', 'error');
                this.value = '';
                return;
            }
            
            showAlert(`Archivo seleccionado: ${file.name} (${fileSize.toFixed(2)} MB)`, 'info');
        }
    });
});

function downloadTemplate() {
    const csvContent = `edad,sexo,peso,talla,imc,tas,tad,perimetro_abdominal,realiza_ejercicio,frecuencia_frutas,medicamentos_hta,Dx_Diabetes_Tipo2_Familia,puntaje_total,riesgo_dm
45,M,80.5,175.0,26.2,130,85,95.0,SI,SI,NO,No,7.5,4.0
38,F,65.0,160.0,25.4,120,80,85.0,NO,NO,NO,No,5.0,2.0
52,M,92.0,170.0,31.8,145,95,102.0,SI,SI,SI,"Si: Padres o Hermanos",12.0,6.5
29,F,58.0,155.0,24.1,115,75,78.0,SI,SI,NO,No,3.0,1.0
61,M,88.0,168.0,31.2,150,90,98.0,NO,NO,SI,"Si: Abuelos, Tios o Primos Hermanos (pero no Padres, Hermanos o Hijos)",15.0,8.0`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'plantilla_dm2.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    showAlert('Plantilla CSV descargada', 'success');
}

function downloadTestDataset() {
    // Crear un enlace para descargar el dataset de prueba del servidor
    const link = document.createElement('a');
    link.href = '/download/test-dataset';
    link.download = 'test_dataset_dm2.csv';
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('Dataset de prueba descargado (25 casos clínicos)', 'success');
}
</script>
{% endblock %}